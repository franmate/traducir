<!DOCTYPE html>
<html lang="gl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor XLIFF Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #22263a;
            --border: #2e3350;
            --accent: #4f8ef7;
            --accent2: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-muted: #64748b;
            --source-bg: #1e2a3a;
            --source-border: #4f8ef7;
            --mono: 'IBM Plex Mono', monospace;
            --sans: 'IBM Plex Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--sans);
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--mono);
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        h1 {
            font-family: var(--mono);
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text);
        }

        .version {
            font-family: var(--mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--surface2);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        /* TOOLBAR */
        .toolbar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-zone {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--accent);
            color: white;
            padding: 9px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .file-label:hover { opacity: 0.85; }

        #file-name {
            font-family: var(--mono);
            font-size: 0.78rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 220px;
        }

        .divider {
            width: 1px;
            height: 32px;
            background: var(--border);
            flex-shrink: 0;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.82rem;
            font-weight: 600;
            font-family: var(--sans);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary   { background: var(--accent);  color: white; }
        .btn-success   { background: var(--success); color: white; }
        .btn-warning   { background: var(--warning); color: #1a1d27; }
        .btn-secondary { background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); }
        .btn-danger    { background: var(--danger);  color: white; }

        button:not(:disabled):hover { filter: brightness(1.12); transform: translateY(-1px); }

        /* LOADING */
        .loading-bar {
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 2px;
            margin-bottom: 16px;
            display: none;
            animation: loadpulse 1.2s ease-in-out infinite;
        }
        .loading-bar.active { display: block; }
        @keyframes loadpulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* STATS */
        .stats {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 20px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .stat-value {
            font-family: var(--mono);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* PROGRESS BAR */
        .progress-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 3px;
            transition: width 0.4s ease;
            width: 0%;
        }

        .progress-pct {
            font-family: var(--mono);
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        /* SEARCH */
        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .search-row input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: var(--sans);
            font-size: 0.9rem;
            padding: 10px 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-row input:focus { border-color: var(--accent); }
        .search-row input::placeholder { color: var(--text-muted); }

        /* TRANSLATION LIST */
        .translation-list {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .translation-item {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 18px 20px;
            transition: background 0.15s;
        }

        .translation-item:last-child { border-bottom: none; }
        .translation-item:hover { background: var(--surface2); }

        .item-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .item-num {
            font-family: var(--mono);
            font-size: 0.72rem;
            color: var(--text-muted);
            background: var(--surface2);
            padding: 2px 7px;
            border-radius: 4px;
        }

        .item-id {
            font-family: var(--mono);
            font-size: 0.78rem;
            color: var(--accent);
            font-weight: 600;
        }

        .item-resname {
            font-family: var(--mono);
            font-size: 0.72rem;
            color: var(--warning);
            background: rgba(245,158,11,0.1);
            padding: 2px 7px;
            border-radius: 4px;
        }

        .item-attrs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .attr-badge {
            font-family: var(--mono);
            font-size: 0.68rem;
            color: var(--text-muted);
            background: var(--surface2);
            padding: 2px 7px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .source-text {
            background: var(--source-bg);
            border-left: 3px solid var(--source-border);
            border-radius: 0 6px 6px 0;
            padding: 10px 14px;
            font-family: var(--mono);
            font-size: 0.85rem;
            color: #93c5fd;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .target-text {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: var(--mono);
            font-size: 0.85rem;
            padding: 10px 14px;
            min-height: 80px;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
            line-height: 1.5;
        }

        .target-text:focus { border-color: var(--accent); }
        .target-text.pending { border-color: rgba(245,158,11,0.4); }
        .target-text.translated { border-color: rgba(16,185,129,0.4); }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .empty-state h3 { font-size: 1.1rem; margin-bottom: 6px; color: var(--text); }
        .empty-state p  { font-size: 0.9rem; }

        footer {
            text-align: center;
            padding: 24px 0 8px;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        footer a { color: var(--accent); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        @media (max-width: 640px) {
            body { padding: 12px; }
            .toolbar { flex-direction: column; }
            .file-zone { flex-wrap: wrap; }
            .divider { display: none; }
        }
    </style>
</head>
<body>
<div class="container">

    <header>
        <div class="logo">XLF</div>
        <h1>Editor XLIFF Online</h1>
        <span class="version">v2.0</span>
    </header>

    <div class="loading-bar" id="loading-bar"></div>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="file-zone">
            <label for="xliff-file" class="file-label">
                ↑ Seleccionar XLIFF
            </label>
            <input type="file" id="xliff-file" accept=".xlf,.xliff" style="display:none">
            <span id="file-name">Ningún ficheiro seleccionado</span>
        </div>

        <div class="divider"></div>

        <div class="btn-group">
            <button id="download-btn" class="btn-success" disabled>↓ Descargar XLIFF</button>
            <button id="export-csv-btn" class="btn-primary" disabled>⇥ Exportar CSV</button>
            <button id="import-csv-btn" class="btn-warning">⇤ Importar CSV</button>
            <button id="clear-btn" class="btn-secondary">✕ Limpar</button>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats" id="stats-section" style="display:none">
        <div class="stat-card">
            <div class="stat-value" id="total-units">0</div>
            <div class="stat-label">Unidades totais</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="translated-units" style="color:var(--success)">0</div>
            <div class="stat-label">Traducidas</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="pending-units" style="color:var(--warning)">0</div>
            <div class="stat-label">Pendentes</div>
        </div>
    </div>

    <div class="progress-wrap" id="progress-wrap" style="display:none">
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <span class="progress-pct" id="progress-pct">0%</span>
    </div>

    <!-- SEARCH -->
    <div class="search-row">
        <input type="text" id="search-input" placeholder="Buscar en textos orixinais ou traducidos...">
        <button id="search-btn" class="btn-primary">⌕ Buscar</button>
    </div>

    <!-- TRANSLATION LIST -->
    <div class="translation-list" id="translation-container">
        <div class="empty-state">
            <div class="empty-icon">⇄</div>
            <h3>Editor XLIFF</h3>
            <p>Selecciona un ficheiro XLIFF para comezar a traducir</p>
        </div>
    </div>

    <footer>
        <p>Editor XLIFF Online &mdash; <a href="https://creativecommons.org/licenses/by/4.0/deed.gl" target="_blank">Creative Commons BY 4.0</a></p>
    </footer>
</div>

<script>
class XLIFFEditor {
    constructor() {
        this.translationUnits = [];
        this.filteredUnits   = [];
        this.currentFile     = null;
        this.rawXmlDoc       = null; // keep original parsed XML
        this.init();
    }

    init() {
        document.getElementById('xliff-file')    .addEventListener('change', e => this.handleFileSelect(e));
        document.getElementById('download-btn')  .addEventListener('click',  () => this.downloadXLIFF());
        document.getElementById('export-csv-btn').addEventListener('click',  () => this.exportCSV());
        document.getElementById('import-csv-btn').addEventListener('click',  () => this.importCSV());
        document.getElementById('clear-btn')     .addEventListener('click',  () => this.clear());
        document.getElementById('search-btn')    .addEventListener('click',  () => this.filter());
        document.getElementById('search-input')  .addEventListener('keyup',  e => { if (e.key === 'Enter') this.filter(); });
    }

    // ─── FILE HANDLING ──────────────────────────────────────────────────────────

    async handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        this.currentFile = file;
        document.getElementById('file-name').textContent = file.name;
        this.setLoading(true);
        try {
            const text = await this.readFile(file);
            this.parseXLIFF(text);
            this.render();
            this.updateStats();
            this.setEnabled(true);
        } catch (err) {
            alert('Erro ao cargar o ficheiro: ' + err.message);
            document.getElementById('file-name').textContent = 'Erro ao cargar';
        } finally {
            this.setLoading(false);
        }
    }

    readFile(file) {
        return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload  = e => res(e.target.result);
            r.onerror = () => rej(new Error('Non se puido ler o ficheiro'));
            r.readAsText(file);
        });
    }

    // ─── XLIFF PARSING (preserves ALL attributes) ───────────────────────────────

    parseXLIFF(content) {
        this.translationUnits = [];

        const parser = new DOMParser();
        const doc    = parser.parseFromString(content, 'text/xml');
        this.rawXmlDoc = doc;

        if (doc.getElementsByTagName('parsererror').length) {
            throw new Error('XML non válido');
        }

        const units = doc.getElementsByTagName('trans-unit');

        for (let i = 0; i < units.length; i++) {
            const unit = units[i];

            // Collect ALL attributes
            const attrs = {};
            for (let a = 0; a < unit.attributes.length; a++) {
                const attr = unit.attributes[a];
                attrs[attr.name] = attr.value;
            }

            const sourceEl = unit.getElementsByTagName('source')[0];
            const targetEl = unit.getElementsByTagName('target')[0];

            const source = sourceEl ? sourceEl.textContent : '';
            let   target = targetEl ? targetEl.textContent : '';

            // Mark untranslated entries
            const isPending = !target || target.trim() === '';

            this.translationUnits.push({
                num:       i + 1,
                id:        attrs.id || String(i),
                attrs:     attrs,          // ALL original attributes preserved
                source:    source,
                target:    target,
                isPending: isPending
            });
        }

        this.filteredUnits = [...this.translationUnits];
    }

    // ─── RENDER ─────────────────────────────────────────────────────────────────

    render() {
        const container = document.getElementById('translation-container');

        if (!this.filteredUnits.length) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">⌕</div>
                    <h3>Sen resultados</h3>
                    <p>Proba con outros termos de busca</p>
                </div>`;
            return;
        }

        container.innerHTML = '';

        this.filteredUnits.forEach(unit => {
            const el = document.createElement('div');
            el.className = 'translation-item';

            // Collect "extra" attrs to show as badges (excluding id and resname shown separately)
            const SKIP = new Set(['id', 'resname']);
            const extraBadges = Object.entries(unit.attrs)
                .filter(([k]) => !SKIP.has(k))
                .map(([k, v]) => `<span class="attr-badge">${this.esc(k)}="${this.esc(v)}"</span>`)
                .join('');

            const resnameBadge = unit.attrs.resname
                ? `<span class="item-resname">resname="${this.esc(unit.attrs.resname)}"</span>`
                : '';

            el.innerHTML = `
                <div class="item-meta">
                    <span class="item-num">#${unit.num}</span>
                    <span class="item-id">id="${this.esc(unit.id)}"</span>
                    ${resnameBadge}
                    <div class="item-attrs">${extraBadges}</div>
                </div>
                <div class="source-text">${this.esc(unit.source)}</div>
                <textarea class="target-text ${unit.isPending ? 'pending' : 'translated'}"
                          data-id="${this.esc(unit.id)}"
                          placeholder="Escribe a tradución...">${this.esc(unit.target)}</textarea>
            `;

            const ta = el.querySelector('textarea');
            ta.addEventListener('input', e => {
                this.updateTranslation(unit.id, e.target.value);
                // Update pending class
                const isEmpty = e.target.value.trim() === '';
                e.target.classList.toggle('pending',    isEmpty);
                e.target.classList.toggle('translated', !isEmpty);
                this.updateStats();
            });

            container.appendChild(el);
        });
    }

    updateTranslation(id, value) {
        const unit = this.translationUnits.find(u => u.id === id);
        if (unit) {
            unit.target    = value;
            unit.isPending = value.trim() === '';
        }
    }

    // ─── STATS ──────────────────────────────────────────────────────────────────

    updateStats() {
        const total      = this.translationUnits.length;
        const translated = this.translationUnits.filter(u => u.target && u.target.trim() !== '').length;
        const pending    = total - translated;
        const pct        = total > 0 ? Math.round((translated / total) * 100) : 0;

        document.getElementById('total-units')     .textContent = total;
        document.getElementById('translated-units').textContent = translated;
        document.getElementById('pending-units')   .textContent = pending;
        document.getElementById('progress-fill')   .style.width = pct + '%';
        document.getElementById('progress-pct')    .textContent = pct + '%';

        document.getElementById('stats-section') .style.display = total > 0 ? 'flex' : 'none';
        document.getElementById('progress-wrap') .style.display = total > 0 ? 'flex' : 'none';
    }

    // ─── SEARCH / FILTER ────────────────────────────────────────────────────────

    filter() {
        const q = document.getElementById('search-input').value.toLowerCase().trim();
        this.filteredUnits = q
            ? this.translationUnits.filter(u =>
                u.source.toLowerCase().includes(q) ||
                u.target.toLowerCase().includes(q) ||
                (u.attrs.resname || '').toLowerCase().includes(q) ||
                u.id.toLowerCase().includes(q)
              )
            : [...this.translationUnits];
        this.render();
    }

    // ─── DOWNLOAD XLIFF (preserves ALL original attributes) ─────────────────────

    downloadXLIFF() {
        if (!this.translationUnits.length) { alert('Non hai datos para descargar'); return; }

        let body = '';
        this.translationUnits.forEach(unit => {
            // Reconstruct opening tag with ALL original attributes
            const attrsStr = Object.entries(unit.attrs)
                .map(([k, v]) => `${k}="${this.escXml(v)}"`)
                .join(' ');

            body += `
      <trans-unit ${attrsStr}>
        <source>${this.escXml(unit.source)}</source>
        <target>${this.escXml(unit.target)}</target>
      </trans-unit>`;
        });

        const xml = `<?xml version="1.0" encoding="UTF-8"?>
<xliff version="1.2" xmlns="urn:oasis:names:tc:xliff:document:1.2">
  <file original="application" source-language="en" target-language="gl" datatype="plaintext">
    <body>${body}
    </body>
  </file>
</xliff>`;

        const baseName = this.currentFile
            ? this.currentFile.name.replace(/\.(xlf|xliff)$/i, '')
            : 'traduzido';

        this.triggerDownload(xml, `${baseName}.xlf`, 'application/x-xliff+xml');
    }

    // ─── EXPORT CSV ─────────────────────────────────────────────────────────────

    exportCSV() {
        if (!this.translationUnits.length) { alert('Non hai datos para exportar'); return; }

        let csv = '"ID","resname","Texto Orixinal","Texto Traducido"\n';
        this.translationUnits.forEach(u => {
            csv += `${this.csvField(u.id)},${this.csvField(u.attrs.resname || '')},${this.csvField(u.source)},${this.csvField(u.target)}\n`;
        });

        const baseName = this.currentFile
            ? this.currentFile.name.replace(/\.(xlf|xliff)$/i, '')
            : 'exportado';

        this.triggerDownload(csv, `${baseName}.csv`, 'text/csv;charset=utf-8;');
    }

    // ─── IMPORT CSV ─────────────────────────────────────────────────────────────

    importCSV() {
        const input = document.createElement('input');
        input.type   = 'file';
        input.accept = '.csv';
        input.onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;
            this.setLoading(true);
            try {
                const text = await this.readFile(file);
                this.parseCSV(text);
                this.render();
                this.updateStats();
                this.setEnabled(true);
                document.getElementById('file-name').textContent = file.name + ' (CSV)';
            } catch (err) {
                alert('Erro ao importar CSV: ' + err.message);
            } finally {
                this.setLoading(false);
            }
        };
        input.click();
    }

    parseCSV(text) {
        this.translationUnits = [];
        const lines = text.split('\n');
        if (lines.length < 2) throw new Error('CSV baleiro ou formato incorrecto');

        // Detect if first column is 'ID' (has header) and how many columns
        const header = this.parseCsvLine(lines[0]);
        const hasResname = header.length >= 4; // ID, resname, source, target

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const f = this.parseCsvLine(line);
            if (f.length < 3) continue;

            let id, resname, source, target;
            if (hasResname) {
                [id, resname, source, target] = f;
            } else {
                [id, source, target] = f;
                resname = '';
            }

            const attrs = { id };
            if (resname) attrs.resname = resname;

            this.translationUnits.push({
                num:       i,
                id:        id,
                attrs:     attrs,
                source:    source,
                target:    target || '',
                isPending: !target || target.trim() === ''
            });
        }

        this.filteredUnits = [...this.translationUnits];
    }

    parseCsvLine(line) {
        const fields = [];
        let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
            const c = line[i];
            if (c === '"') {
                if (inQ && line[i+1] === '"') { cur += '"'; i++; }
                else { inQ = !inQ; }
            } else if (c === ',' && !inQ) {
                fields.push(cur); cur = '';
            } else {
                cur += c;
            }
        }
        fields.push(cur);
        return fields;
    }

    // ─── CLEAR ──────────────────────────────────────────────────────────────────

    clear() {
        this.translationUnits = [];
        this.filteredUnits    = [];
        this.currentFile      = null;
        this.rawXmlDoc        = null;
        document.getElementById('xliff-file').value   = '';
        document.getElementById('file-name').textContent = 'Ningún ficheiro seleccionado';
        document.getElementById('search-input').value = '';
        this.setEnabled(false);
        this.updateStats();
        document.getElementById('translation-container').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">⇄</div>
                <h3>Editor XLIFF</h3>
                <p>Selecciona un ficheiro XLIFF para comezar a traducir</p>
            </div>`;
    }

    // ─── HELPERS ────────────────────────────────────────────────────────────────

    setLoading(on) {
        document.getElementById('loading-bar').classList.toggle('active', on);
    }

    setEnabled(on) {
        document.getElementById('download-btn')  .disabled = !on;
        document.getElementById('export-csv-btn').disabled = !on;
    }

    triggerDownload(content, filename, mime) {
        const blob = new Blob([content], { type: mime });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    csvField(v) {
        return '"' + String(v || '').replace(/"/g, '""') + '"';
    }

    esc(text) {
        const d = document.createElement('div');
        d.textContent = String(text || '');
        return d.innerHTML;
    }

    escXml(text) {
        return String(text || '')
            .replace(/&/g,  '&amp;')
            .replace(/</g,  '&lt;')
            .replace(/>/g,  '&gt;')
            .replace(/"/g,  '&quot;')
            .replace(/'/g,  '&apos;');
    }
}

document.addEventListener('DOMContentLoaded', () => new XLIFFEditor());
</script>
</body>
</html>
